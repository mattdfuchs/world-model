services:
  neo4j:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: "${NEO4J_USER}/${NEO4J_PASSWORD}"
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs

  mcp-neo4j:
    build:
      context: ./mcp/neo4j
      args:
        NEO4J_MCP_VERSION: "${MCP_NEO4J_VERSION}"
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_TRANSPORT_MODE: http
      NEO4J_MCP_HTTP_HOST: 0.0.0.0
      NEO4J_MCP_HTTP_PORT: "${MCP_NEO4J_PORT}"
    ports:
      - "${MCP_NEO4J_PORT}:${MCP_NEO4J_PORT}"
    depends_on:
      - neo4j

  python-mcp:
    build:
      context: ./python
    environment:
      PY_MCP_PORT: "${PY_MCP_PORT}"
      LEAN_PROJECT_PATH: /app/lean4
    ports:
      - "${PY_MCP_PORT}:7010"
    volumes:
      - ./lean4:/app/lean4
      - elan_cache:/root/.elan

  n8n:
    build:
      context: ./n8n
    ports:
      - "${N8N_PORT}:5678"
    environment:
      N8N_BASIC_AUTH_ACTIVE: "${N8N_BASIC_AUTH_ACTIVE}"
      N8N_BASIC_AUTH_USER: "${N8N_BASIC_AUTH_USER}"
      N8N_BASIC_AUTH_PASSWORD: "${N8N_BASIC_AUTH_PASSWORD}"
      NEO4J_MCP_AUTH_HEADER: "${NEO4J_MCP_AUTH_HEADER}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      N8N_BLOCK_ENV_ACCESS_IN_NODE: "false"
      NODE_FUNCTION_ALLOW_EXTERNAL: "axios"
      NODE_FUNCTION_ALLOW_BUILTIN: "fs"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./mcp/neo4j/script.txt:/home/node/.n8n-files/script.txt:ro
      - ./n8n/workflows/test-components.json:/home/node/.n8n-files/test-components.json:ro
    depends_on:
      - mcp-neo4j
      - python-mcp

volumes:
  neo4j_data:
  neo4j_logs:
  n8n_data:
  elan_cache:
